# Migrating from 0.1.x to 0.2.0

The 0.2.0 release of the SpacetimeDB SDK addon includes a **BIG** refactor to align the SDK with the official SpacetimeDB client libraries.

This migration guide will help you migrate your project to use the new SDK apis.

## Breaking Changes

-   Generated files are now located at `res://spacetime_bindings/` instead of `res://spacetime_data/`
-   Renamed server and client message resources from `..Data` to `..Message`
-   The `SpacetimeDB` autoload is now just a holder for the generated module clients, you should now access everything via `SpacetimeDB.MyModule` where `MyModule` is the PascalCase name of your module.
-   Removed the `identity_received` signal, the identity and token are now passed to the `connected` signal
-   `get_local_identity()` now returns a just the `PackedByteArray` instead of the `IdentityTokenMessage`
-   All identities are now reversed in the `BSATNDeserializer`, so you no longer need to call `.reverse()` on the identity yourself
-   `subscribe()` now returns a [`SpacetimeDBSubscription`](../api.md#spacetimedbsubscription-class) instance
-   `call_reducer()` now returns a [`SpacetimeDBReducerCall`](../api.md#spacetimedbreducercall-class) instance

## Steps to migrate

### 1. Regenerate your module bindings

Readd your module(s) to the SpacetimeDB addon via the SpacetimeDB tab in the Godot editor. Then click the `Generate schema` button to regenerate the bindings.

### 2. Update your usage of the `SpacetimeDB` autoload

The `SpacetimeDB` autoload is now just a holder for the generated module clients, you should now access everything via `SpacetimeDB.MyModule` where `MyModule` is the PascalCase name of your module.

Change your `connect_db()` calls and signal connections to do it via the relevant module client:

```gdscript
SpacetimeDB.MyModule.connected.connect(_on_spacetimedb_connected)
SpacetimeDB.MyModule.disconnected.connect(_on_spacetimedb_disconnected)
SpacetimeDB.MyModule.connection_error.connect(_on_spacetimedb_connection_error)
SpacetimeDB.MyModule.database_initialized.connect(_on_spacetimedb_database_init)

SpacetimeDB.MyModule.connect_db( # <--- replace 'MyModule' with your module name
    "http://url.to.your.server:3000",
    "your-module-name",
    options
)

var subscription := SpacetimeDB.MyModule.subscribe(query)
```

Remove your connections to the `identity_received` signal, and update your `connected` callbacks to take the identity and token arguments:

```gdscript
func _on_spacetimedb_connected(identity: PackedByteArray, token: String):
    # Your code here
```

Change reducers access from `MyModule.Reducers.my_reducer()` and `MyModule.my_reducer()` to the new location under `SpacetimeDB.MyModule.reducers`:

```gdscript
SpacetimeDB.MyModule.reducers.my_reducer(arg1, arg2)
```

Update your `get_local_identity()` calls to use the returned `PackedByteArray` instead of the `IdentityTokenMessage`:

```gdscript
var identity := SpacetimeDB.MyModule.get_local_identity()
```

### 3. Remove `reverse()` calls on identities

If you use an identity in a subscription you will have needed to call `.reverse()` on it to get the correct identity format, all identities are now reversed in the `BSATNDeserializer` so they can be used directly.

```gdscript
var identity := SpacetimeDB.MyModule.get_local_identity()
var query := "SELECT * FROM players WHERE identity = 0x%s" % identity.hex_encode()
```

### 4. Update subscriptions to use `SpacetimeDBSubscription` handles

The `subscribe()` method no longer returns just a request id, it now returns a [`SpacetimeDBSubscription`](../api.md#spacetimedbsubscription-class) instance.

```gdscript
var query := ["SELECT * FROM players"]

var subscription := SpacetimeDB.MyModule.subscribe(query)
if subscription.error:
    print("Subscription failed:", subscription.error)
    return

subscription.applied.connect(_on_subscription_applied)
subscription.end.connect(_on_subscription_ended)

# Close the subscription
subscription.unsubscribe()
```

### 5. (Optional) Replace usage of `get_local_database()` with the typed `.db` property

A typed version of the local database is now available via the `SpacetimeDB.MyModule.db` property. This property is a `ModuleDb` type which has a property for each table in your module.

Change `get_all_rows()` calls to use the typed table:

```gdscript
var rows := SpacetimeDB.MyModule.db.players.iter()
```

Change `get_row()` calls to use the typed unique index:

```gdscript
var row := SpacetimeDB.MyModule.db.players.identity.find(identity)
```

### 6. Update the `table_to_receive` references in `RowReceiver` nodes

All generated table types have moved so references to them in `RowReceiver` nodes need to be updated to point to the new table types.

### 7. Update generated types access

You can still access the generated module types via their global class names, but access to types via `MyModule.Type` and `MyModule.Types.Type` have moved under `SpacetimeDB.MyModule.Type` (or `SpacetimeDB.MyModule.Types.Type`), you can also access them via the module client global class: `MyModuleClient.Type` (or `MyModuleClient.Types.Type`).
